#!/bin/env php
<?php

// phpflickr will call session_start() even though we are a CLI program.
// Don't bother trying to save session data.
require_once (dirname(__FILE__).'/../include/NullSessionHandler.php');
session_set_save_handler(new NullSessionHandler);

require_once (dirname(__FILE__).'/../include/init.php');

$usage ="Usage:\n\t".$argv[0]." [-hqs]

	-h Show this help.
	-q Quiet. Only show summary output.
	-s Print a final summary at the end of the run.
";
$options = getOptionArray(__FILE__, $argv);
$params = getParameterArray(__FILE__, $argv);

if (isset($options['h']) || isset($options['help']) || count($params) !== 0) {
	print $usage;
	exit(1);
}

$starting_decade = floor(intval(date('Y'))/10) * 10;

$summaries = [];

for ($decade = $starting_decade; $decade >= 1900; $decade = $decade - 10) {
	if (!isset($options['q'])) {
		print "Processing $decade\n";
	}
	if ($decade >= 1910) {
		$min_date = $decade.'-01-01 00:00:00';
		$max_date = ($decade + 9).'-12-30 23:59:59';
	} else {
		$decade = 1900;
		$min_date = null;
		$max_date = '1909-12-30 23:59:59';
	}
	$sort = 'date-taken-asc';

	$args = array(
		'user_id' => $FLICKR_USERID,
		'min_taken_date' => $min_date,
		'max_taken_date' => $max_date,
		'sort' => $sort,
		'extras' => 'description,date_taken,url_o,url_t,url_l,url_b,url_h,url_k,tags,machine_tags,last_update',
	);

	$wall_config = array(
		'base_url' => $WALL_BASE_URL,
		'auth_token' => $WALL_AUTH_TOKEN,
	);

	$updater = new PhotoUpdater($WALL_CATEGORIES, $IMAGE_CACHE_DIR, $wall_config);
	if (isset($options['q'])) {
		$updater->verbose = false;
	}
	try {
		$updater->update(
			new PhotoSearchIterator($flickr, $args, 0, 100)
		);
	} catch (Exception $e) {
		$message = "Exception processing $decade: " . substr($e->getMessage(), 0, 1024) . "\n";
		$summaries[] = $message;
		print $message;
	}

	ob_start();
	print $decade . ": ";
	$updater->printSummary();
	$summary = ob_get_clean();
	$summaries[] = $summary;
	print $summary;
}

if (isset($options['s'])) {
	print "\n\nFinal summary:\n" . implode("", $summaries);
}
